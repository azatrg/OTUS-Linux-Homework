# Фильтрация траффика

## Домашнее задание

1) реализовать knocking port
- centralRouter может попасть на ssh inetRouter через knock скрипт
пример в материалах
2) добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост
3) запустить nginx на centralServer
4) пробросить 80й порт на inetRouter2 8080
5) дефолт в инет оставить через inetRouter

* реализовать проход на 80й порт без маскарадинга

---

## Проверка

1. Для входа на inetRouter запустить скрипт knock.sh


```
/vagrant/knock.sh
```
Скрипт последовательно подключиться к портам 8881, 7777, 9991 затем откроет ssh. **Логин\пароль - vagrant\vagrant**

2. Добавил inetRouter2 c hostonly сетью и ip-адресом 192.168.50.2 Пробросил порт 8080 на 80 порт centralServer.
Для проверки открыть 192.168.50.2:8080 с хостовой машины. Откроеться nginx расположенный на centralServer.

---

![Схема](https://github.com/azatrg/OTUS-Linux-Homework/blob/master/homework-17/iptables.jpeg)

## Решение

### knocking port

1. Предварительно на inetrouter включить в настроках sshd password authentication 

2. На inetRouter настроил iptables. Конфиг для port-knocking ниже.

```

*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:SSH-INPUT - [0:0]
:SSH-INPUTTWO - [0:0]
:TRAFFIC - [0:0]
-A INPUT -i eth0 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT
-A INPUT -j TRAFFIC 
-A SSH-INPUT -m recent --set --name SSH1 --rsource -j DROP 
-A SSH-INPUTTWO -m recent --set --name SSH2 --rsource -j DROP 
-A TRAFFIC -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 22 -m recent --rcheck --seconds 30 --name SSH2 --rsource -j ACCEPT 
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH2 --rsource -j DROP 
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH2 --rsource -j DROP 
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 9991 -m recent --rcheck --name SSH1 --rsource -j SSH-INPUTTWO 
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH1 --rsource -j DROP 
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 7777 -m recent --rcheck --name SSH0 --rsource -j SSH-INPUT 
-A TRAFFIC -p tcp -m state --state NEW -m tcp -m recent --remove --name SSH0 --rsource -j DROP 
-A TRAFFIC -p tcp -m state --state NEW -m tcp --dport 8881 -m recent --set --name SSH0 --rsource -j DROP 
COMMIT

*nat
:PREROUTING ACCEPT [4:508]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [58:4644]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE 
COMMIT
```

3. На centralRouter установить nmap и добавить knock script.


4. ФАйрволл на inetrouter2

```
# Generated by iptables-save v1.4.21 on Sat May  9 11:36:50 2020
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [70:5456]
:LOGGING - [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i eth0 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -i eth2 -p tcp -m tcp --dport 80 -j ACCEPT
-A FORWARD -d 192.168.0.2/32 -p tcp -m tcp --dport 80 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth1 -o eth2 -j ACCEPT
-A FORWARD -j LOGGING
-A LOGGING -m limit --limit 2/min -j LOG --log-prefix "IPTables-Dropped: "
-A LOGGING -j DROP
COMMIT
# Completed on Sat May  9 11:36:50 2020
# Generated by iptables-save v1.4.21 on Sat May  9 11:36:50 2020
*nat
:PREROUTING ACCEPT [5:420]
:INPUT ACCEPT [3:252]
:OUTPUT ACCEPT [85:6408]
:POSTROUTING ACCEPT [106:7652]
-A PREROUTING -i eth2 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.168.0.2:80
COMMIT
# Completed on Sat May  9 11:36:50 2020
```

